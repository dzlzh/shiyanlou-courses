# ä½¿ç”¨ Hook å°†ä»£ç ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯é€šè¿‡é‚®ä»¶å‘é€

## ä¸€ã€å®éªŒç®€ä»‹

### 1.1 å®éªŒå†…å®¹

é€šè¿‡ç¼–å†™ Python è„šæœ¬ï¼Œåˆ©ç”¨ Git Hook å®ç° `git log` çš„ä¿¡æ¯é€šè¿‡é‚®ä»¶æŒ‡å®šå‘é€ã€‚

### 1.2 å®éªŒçŸ¥è¯†ç‚¹

- Git

### 1.3 å®éªŒç¯å¢ƒ

- Xfce ç»ˆç«¯
- Git CLI
- Python 2.7

### 1.4 é€‚åˆäººç¾¤

æœ¬è¯¾ç¨‹éš¾åº¦å±äºä¸€èˆ¬ï¼Œå±äºåˆçº§çº§åˆ«è¯¾ç¨‹ï¼Œé€‚åˆå…·æœ‰ Git åŸºç¡€çš„ç”¨æˆ·ã€‚

## äºŒã€Python smtp é‚®ä»¶å‘é€

**SMTPï¼ˆSimple Mail Transfer Protocolï¼‰**å³ç®€å•é‚®ä»¶ä¼ è¾“åè®®, å®ƒæ˜¯ä¸€ç»„ç”¨äºç”±æºåœ°å€åˆ°ç›®çš„åœ°å€ä¼ é€é‚®ä»¶çš„è§„åˆ™ï¼Œç”±å®ƒæ¥æ§åˆ¶ä¿¡ä»¶çš„ä¸­è½¬æ–¹å¼ã€‚

Python çš„ smtplib æä¾›äº†ä¸€ç§å¾ˆæ–¹ä¾¿çš„é€”å¾„å‘é€ç”µå­é‚®ä»¶ã€‚å®ƒå¯¹ smtp åè®®è¿›è¡Œäº†ç®€å•çš„å°è£…ã€‚

Python åˆ›å»º SMTP å¯¹è±¡è¯­æ³•å¦‚ä¸‹ï¼š

```
import smtplib

smtpObj = smtplib.SMTP( [host [, port [, local_hostname]]] )

```

å‚æ•°è¯´æ˜ï¼š

- host: SMTP æœåŠ¡å™¨ä¸»æœºã€‚ ä½ å¯ä»¥æŒ‡å®šä¸»æœºçš„ ip åœ°å€æˆ–è€…åŸŸåå¦‚: runoob.comï¼Œè¿™ä¸ªæ˜¯å¯é€‰å‚æ•°ã€‚
- port: å¦‚æœä½ æä¾›äº† host å‚æ•°, ä½ éœ€è¦æŒ‡å®š SMTP æœåŠ¡ä½¿ç”¨çš„ç«¯å£å·ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ SMTP ç«¯å£å·ä¸º 25ã€‚
- local_hostname: å¦‚æœ SMTP åœ¨ä½ çš„æœ¬æœºä¸Šï¼Œä½ åªéœ€è¦æŒ‡å®šæœåŠ¡å™¨åœ°å€ä¸º localhost å³å¯ã€‚

Python SMTP å¯¹è±¡ä½¿ç”¨ `sendmail` æ–¹æ³•å‘é€é‚®ä»¶ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

```
SMTP.sendmail(from_addr, to_addrs, msg[, mail_options, rcpt_options]

```

å‚æ•°è¯´æ˜ï¼š

- from_addr: é‚®ä»¶å‘é€è€…åœ°å€ã€‚
- to_addrs: å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œé‚®ä»¶å‘é€åœ°å€ã€‚
- msg: å‘é€æ¶ˆæ¯

è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œmsg æ˜¯å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºé‚®ä»¶ã€‚æˆ‘ä»¬çŸ¥é“é‚®ä»¶ä¸€èˆ¬ç”±æ ‡é¢˜ï¼Œå‘ä¿¡äººï¼Œæ”¶ä»¶äººï¼Œé‚®ä»¶å†…å®¹ï¼Œé™„ä»¶ç­‰æ„æˆï¼Œå‘é€é‚®ä»¶çš„æ—¶å€™ï¼Œè¦æ³¨æ„ msg çš„æ ¼å¼ã€‚è¿™ä¸ªæ ¼å¼å°±æ˜¯ smtp åè®®ä¸­å®šä¹‰çš„æ ¼å¼ã€‚

æœ‰äº†ä»¥ä¸ŠåŸºç¡€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦åœ¨ Hook è„šæœ¬ä¸­ä½¿ç”¨å®ƒã€‚

## ä¸‰ã€åœ¨è„šæœ¬ä¸­å®ç°å‘é€é‚®ä»¶

åŒæ ·çš„ï¼Œæˆ‘ä»¬æ‰“å¼€ `post-commit` æ–‡ä»¶ï¼š

```
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import smtplib
from email.mime.text import MIMEText
from email.header import Header
from subprocess import check_output

# è¿è¥å•† smtp åœ°å€ï¼Œè¿™é‡Œä»¥ QQ é‚®ç®±ä¸ºä¾‹
mail_host = "smtp.qq.com"
# é‚®ç®± idï¼ˆè‡ªè¡Œæ›¿æ¢ï¼‰
mail_user = "12345678@qq.com"
# é‚®ç®± å¯†ç ï¼ˆè‡ªè¡Œæ›¿æ¢ï¼‰
mail_pass = "shiyanlou"

log = check_output(['git', 'log', '-1', '-p'])
m = log.split('\n')[4][4:]
# æˆ‘ä»¬å¯¹è¾“å…¥å‚æ•°ä½¿ç”¨ç©ºæ ¼åˆ‡å‰²ï¼Œå¹¶æ‹¿åˆ°æœ€åä¸€ä¸ªå‚æ•°
arg = m.split(' ')[-1]

if arg[:6] == 'email:':
    receiver = arg[6:]
    sender = mail_user
    receivers = [receiver]

    message = MIMEText(log)
    message['From'] = Header(mail_user, 'utf-8')
    message['To'] =  Header(str(receivers), 'utf-8')

    subject = 'This is a commit log for you!'
    message['Subject'] = Header(subject, 'utf-8')

    try:
        smtpObj = smtplib.SMTP_SSL(mail_host, 465)
        smtpObj.login(mail_user,mail_pass)
        smtpObj.sendmail(sender, receivers, message.as_string())
        smtpObj.quit()
        print ("Send the diff email to:", receiver)
    except smtplib.SMTPException,e:
        print (e)

```

æˆ‘ä»¬æ¥å…·ä½“è®²è§£ä¸€ä¸‹è¿™ä¸ªæ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼š

```
# æˆ‘ä»¬å¯¹è¾“å…¥å‚æ•°ä½¿ç”¨ç©ºæ ¼åˆ‡å‰²ï¼Œå¹¶æ‹¿åˆ°æœ€åä¸€ä¸ªå‚æ•°
arg = m.split(' ')[-1]

if arg[:6] == 'email:':
    receiver = arg[6:]

```

ç¬¬ä¸€è¡Œä»£ç æˆ‘ä»¬å°† `git commit` å‘½ä»¤ä½¿ç”¨ç©ºæ ¼åˆ†å‰²ï¼Œç„¶åå–å‡ºæœ€åä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°çš„æ ¼å¼æ˜¯ `email:xxxxxxx@xx.com`é‚£ä¹ˆ `receiver` å˜é‡åˆ™ä¼šè·å–åˆ°è¿™ä¸ªé‚®ç®±ã€‚

ä¾‹å¦‚æˆ‘ä»¬æäº¤çš„æ—¶å€™è¾“å…¥ `git commit -m 'Complete this function. email:shiyanlou@qq.com'`ï¼Œæ­¤æ—¶ `receiver` å˜é‡å°†ä¼šè·å–åˆ° `shiyanlou@qq.com` è¿™ä¸ª email idã€‚å¹¶åœ¨ä¹‹åé€šè¿‡ä¹‹å‰å¯¹ smtp å¯¹è±¡çš„é…ç½®è¿›è¡Œé‚®ä»¶å‘é€ã€‚

```
message = MIMEText(log)
message['From'] = Header(mail_user, 'utf-8')
message['To'] =  Header(str(receivers), 'utf-8')

subject = 'This is a commit log for you!'
message['Subject'] = Header(subject, 'utf-8')

```

è¿™æ®µä»£ç æˆ‘ä»¬å®šä¹‰äº†é‚®ä»¶å†…å®¹ - logã€å‘ä»¶äºº - mail_userã€æ”¶ä»¶äºº - receiversï¼ˆè¿™é‡Œæ˜¯ä¸€ä¸ª arrayï¼Œæ‰€ä»¥ smtp é‚®ä»¶å‘é€æ˜¯æ”¯æŒç¾¤å‘çš„ï¼‰ã€é‚®ä»¶ä¸»é¢˜ - subjectã€‚

```
try:
    smtpObj = smtplib.SMTP_SSL(mail_host, 465)
    smtpObj.login(mail_user,mail_pass)
    smtpObj.sendmail(sender, receivers, message.as_string())
    smtpObj.quit()
    print ("Send the diff email to:", receiver)
except smtplib.SMTPException,e:
    print (e)

```

è¿™ä¸€æ®µå¼‚å¸¸å¤„ç†çš„ä»£ç å°±æ˜¯åˆ¤æ–­é‚®ä»¶å‘é€çš„æƒ…å†µã€‚`465` æ˜¯é»˜è®¤çš„ smtp æœåŠ¡ç«¯å£ã€‚å½“å‘é€æˆåŠŸåï¼Œå°±ä¼šåœ¨ç»ˆç«¯æ˜¾ç¤º `Send the diff email to: shiyanlou@qq.com`ã€‚

æˆ‘ä»¬æ¥åšä¸€ä¸ªå®éªŒï¼Œåœ¨ä¿®æ”¹ `README.md` ä¹‹åï¼Œè¿›è¡Œä»£ç æäº¤ã€‚åœ¨ `commit` ä¿¡æ¯ä¸­è®°ç€å¢åŠ è‡ªå®šä¹‰å‚æ•° `email:xxx`ï¼Œè¿™é‡Œä¸ºäº†æµ‹è¯•æˆ‘å¡«å†™æˆ‘è‡ªå·±çš„é‚®ç®±ï¼š

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://dn-anything-about-doc.qbox.me/document-uid370033labid2873timestamp1493365782719.png/wm)

çœ‹è§å‘é€æˆåŠŸçš„ logï¼Œè¿™æ—¶å€™æˆ‘æ”¶åˆ°äº†ä¸€å°é‚®ä»¶ï¼Œé‡Œé¢æœ‰æœ¬æ¬¡æäº¤çš„æ‰€æœ‰ä¿®æ”¹ä¿¡æ¯ï¼š

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://dn-anything-about-doc.qbox.me/document-uid370033labid2873timestamp1493365881268.png/wm)

æ˜¯ä¸æ˜¯å¾ˆæœ‰è¶£ğŸ˜„ã€‚

## ä¸‰ã€ä½¿ç”¨ mailgun åˆ›å»ºé‚®ä»¶æœåŠ¡ç«™

ç”±äºä½¿ç”¨ç§äººçš„é‚®ç®±è¿›è¡Œè„šæœ¬è¯å‘é€é‚®ä»¶å­˜åœ¨ä¸€å®šçš„é£é™©æ€§ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€äº›é‚®ä»¶æœåŠ¡çš„ç½‘ç«™ä¸Šç”³è¯·é‚®ä»¶å‘é€å…è´¹æœåŠ¡ã€‚è¿™é‡Œæˆ‘æ¨èä½¿ç”¨ [mailgun](https://www.shiyanlou.com/courses/816/labs/2873/mailgun.com) ã€‚**mailgun** çš„å…è´¹ç”¨æˆ·å¯ä»¥åœ¨ä¸€å°æ—¶ä¹‹å†…å‘é€ 100 å°é‚®ä»¶ï¼Œæˆ‘æƒ³è¿™å·²ç»è¶³å¤Ÿä½ ä½¿ç”¨äº†ã€‚

ç”³è¯·è´¦å·ä¹‹åï¼Œå¯ä»¥è·å–åˆ°ä¸€ä¸ªå‘é€ç«™é‚®ç®±ï¼Œä»¥åŠ smtp çš„æœåŠ¡å™¨ç«¯å£å·ç­‰ç­‰ä¿¡æ¯ã€‚

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://dn-anything-about-doc.qbox.me/document-uid370033labid2873timestamp1493366113004.png/wm)

å†é€šè¿‡ä»¥ä¸Šä»£ç ä½¿ç”¨ smtp æœåŠ¡å‘é€é‚®ä»¶ã€‚å¦å¤–é‚®ä»¶çš„æ¥å—è€…éœ€è¦åœ¨è´¦å·ä¸­æˆæƒæ‰å¯ä»¥æ¥å— mailgun æœåŠ¡å‘é€çš„é‚®ä»¶ã€‚

## å››ã€å®éªŒæ€»ç»“

å®Œæˆæ•´ä¸ª Coding Reviewing è¿‡ç¨‹ï¼Œå¹¶ä¸”é€šè¿‡ç¬¬ä¸‰æ–¹é‚®ä»¶æœåŠ¡ï¼Œç®€å†ç¨³å®šçš„é‚®ä»¶å‘é€ç«™ã€‚

## äº”ã€å°ä½œä¸š

åœ¨å‚æ•°è·å–ä¸­ï¼Œæˆ‘ä»¬æ­¤ç« ä¸­çš„å¯¹äº commit ä¿¡æ¯å‚æ•°çš„è·å–ï¼Œåªæ˜¯ä½¿ç”¨äº†æœ€åŸºæœ¬çš„åŒ¹é…ï¼Œå¹¶ä¸” `email` å‚æ•°åªèƒ½æ”¾åœ¨æäº¤ä¿¡æ¯çš„æœ«å°¾å¤„ã€‚æœ€é€šç”¨çš„åšæ³•åº”è¯¥æ˜¯ä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼Œå°†è¯¥å‚æ•°ä»å¾ˆé•¿çš„ä¿¡æ¯ä¸­æå–å‡ºæ¥ã€‚è¿™é‡Œå¸Œæœ›ä½ æ¥æ”¹å–„è¿™ä¸ªåŠŸèƒ½ï¼Œå®Œæˆåœ¨ commit ä¿¡æ¯ä¸­ä»»æ„ä½ç½®æ’å…¥ `email:xxxx@xx.com` å‚æ•°éƒ½èƒ½è·å–åˆ°æ¥å—è€…é‚®ç®±åœ°å€ã€‚