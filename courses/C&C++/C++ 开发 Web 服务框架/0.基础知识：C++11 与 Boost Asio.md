# C++ å¼€å‘ Web æœåŠ¡æ¡†æ¶ - åŸºç¡€çŸ¥è¯†ï¼šC++11 ä¸ Boost Asio

## ä¸€ã€æ¦‚è¿°

### é¡¹ç›®ä»‹ç»

æœåŠ¡å™¨å¼€å‘ä¸­ Web æœåŠ¡æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ä»£ç å•å…ƒï¼Œå°†æœåŠ¡ç«¯çš„è¯·æ±‚å’Œå“åº”éƒ¨åˆ†çš„é€»è¾‘æŠ½è±¡å‡ºæ¥å½¢æˆæ¡†æ¶ï¼Œèƒ½å¤Ÿåšåˆ°æœ€é«˜çº§åˆ«çš„æ¡†æ¶çº§ä»£ç å¤ç”¨ã€‚æœ¬æ¬¡é¡¹ç›®å°†ç»¼åˆä½¿ç”¨ C++11 åŠ Boost ä¸­çš„ Asio å®ç° HTTP å’Œ HTTPS çš„æœåŠ¡å™¨æ¡†æ¶ã€‚

### é¡¹ç›®æ¶‰åŠçš„çŸ¥è¯†ç‚¹

- C++åŸºæœ¬çŸ¥è¯†
    - é¢å‘å¯¹è±¡
    - æ¨¡æ¿
    - å‘½åç©ºé—´
    - å¸¸ç”¨ IO åº“
- C++11 ç›¸å…³
    - lambda expression
    - std::shared_ptr
    - std::make_shared
    - std::unordered_map
    - std::regex
    - std::smatch
    - std::regex_match
    - std::function
    - std::thread
- Boost Asio ç›¸å…³
    - boost::asio::io_service
    - boost::asio::ip::tcp::socket
    - boost::asio::ip::tcp::v4()
    - boost::asio::ip::tcp::endpoint
    - boost::asio::ip::tcp::acceptor
    - boost::asio::streambuf
    - boost::asio::async_read
    - boost::asio::async_read_until
    - boost::asio::async_write
    - boost::asio::transfer_exactly
    - boost::asio::ssl::stream
    - boost::asio::ssl::stream_base::server
    - boost::asio::ssl::context
    - boost::asio::ssl::context::sslv23
    - boost::asio::ssl::context::pem
    - boost::system::error_code

### ç¼–è¯‘ç¯å¢ƒæç¤º

åœ¨ g++ 4.9 ä¹‹å‰ï¼Œregex åº“å¹¶ä¸æ”¯æŒ ECMAScript çš„æ­£åˆ™è¯­æ³•ï¼Œæ¢å¥è¯è¯´ï¼Œåœ¨ g++4.9 ä¹‹å‰ï¼Œg++ å¯¹ C++11 æ ‡å‡†åº“çš„æ”¯æŒå¹¶ä¸å®Œå–„ï¼Œä¸ºä¿è¯æœ¬æ¬¡é¡¹ç›®çš„é¡ºåˆ©è¿›è¡Œï¼Œè¯·ç¡®ä¿å°† g++ ç‰ˆæœ¬å‡çº§è‡³ 4.9 ä»¥ä¸Šã€‚

```cpp
// ä¸‹é¢çš„è¿™æ®µä»£ç å¯ä»¥æµ‹è¯•ä½ çš„ç¼–è¯‘å™¨å¯¹æ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒæƒ…å†µ
#include &lt;iostream&gt;
#include &lt;regex&gt;

int main()
{
    std::regex r1(&#34;S&#34;);
    printf(&#34;S works.\n&#34;);
    std::regex r2(&#34;.&#34;);
    printf(&#34;. works.\n&#34;);
    std::regex r3(&#34;.+&#34;);
    printf(&#34;.+ works.\n&#34;);
    std::regex r4(&#34;[0-9]&#34;);
    printf(&#34;[0-9] works.\n&#34;);
    return 0;
}
```

å¦‚æœä½ çš„è¿è¡Œç»“æœé‡åˆ°äº†ä¸‹å›¾æ‰€ç¤ºçš„é”™è¯¯ï¼Œè¯´æ˜ä½ ç¡®å®éœ€è¦å‡çº§ä½ çš„ g++ äº†ï¼š

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://dn-anything-about-doc.qbox.me/document-uid29879labid1983timestamp1470712981563.png/wm)

ä½¿ç”¨ `g++ -v` å¯ä»¥æŸ¥çœ‹åˆ°å½“å‰ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼š

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://dn-anything-about-doc.qbox.me/document-uid29879labid1983timestamp1470712986656.png/wm)

&gt; å¦‚æœä½ æœ€åä¸€è¡Œä¸­çš„ `gcc version` æ˜¾ç¤ºçš„æ˜¯ `4.8.x`ï¼Œé‚£ä¹ˆä½ éœ€è¦æ‰‹åŠ¨å°†ç¼–è¯‘å™¨ç‰ˆæœ¬å‡çº§è‡³ `4.9` ä»¥ä¸Šï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
&gt; 
&gt; 
&gt; ```bash
&gt; # å®‰è£… add-apt-repository å·¥å…·
&gt; sudo apt-get install software-properties-common
&gt; # å¢åŠ æº
&gt; sudo add-apt-repository ppa:ubuntu-toolchain-r/test
&gt; # æ›´æ–°æº
&gt; sudo apt-get update
&gt; # æ›´æ–°å®‰è£…
&gt; sudo apt-get upgrade
&gt; # å®‰è£… gcc/g++ 4.9
&gt; sudo apt-get install gcc-4.9 g++-4.9
&gt; # æ›´æ–°é“¾æ¥
&gt; sudo updatedb
&gt; sudo ldconfig
&gt; sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 48 \
&gt;  --slave /usr/bin/g++ g++ /usr/bin/g++-4.8 \
&gt;  --slave /usr/bin/gcc-ar gcc-ar /usr/bin/gcc-ar-4.8 \
&gt;  --slave /usr/bin/gcc-nm gcc-nm /usr/bin/gcc-nm-4.8 \
&gt;  --slave /usr/bin/gcc-ranlib gcc-ranlib /usr/bin/gcc-ranlib-4.8
&gt; sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 49 \
&gt;  --slave /usr/bin/g++ g++ /usr/bin/g++-4.9 \
&gt;  --slave /usr/bin/gcc-ar gcc-ar /usr/bin/gcc-ar-4.9 \
&gt;  --slave /usr/bin/gcc-nm gcc-nm /usr/bin/gcc-nm-4.9 \
&gt;  --slave /usr/bin/gcc-ranlib gcc-ranlib /usr/bin/gcc-ranlib-4.9
&gt; ```

æ­¤å¤–ï¼Œæœ¬æ¬¡é¡¹ç›®ä¾èµ–äº† `Boost` å’Œ `OpenSSL` è¿™ä¸¤ä¸ªåº“ï¼Œä¸è¿‡å¥½åœ¨å®éªŒæ¥¼çš„ç¯å¢ƒå·²ç»æä¾›äº†è¿™ä¸¤ä¸ªéå¸¸åŸºæœ¬çš„åº“ï¼Œä½ ä¸éœ€è¦å†æ“å¿ƒä»–ä»¬çš„å®‰è£…äº†ã€‚

## ä¸€ã€C++ åŸºç¡€

é¢å‘å¯¹è±¡å’Œæ¨¡æ¿æ˜¯ C++è¿›é˜¶çŸ¥è¯†çš„åŸºç¡€ï¼Œè¿™é‡Œä¸åšè¿‡å¤šä»‹ç»ï¼Œæœ¬æ¬¡é¡¹ç›®æˆ‘ä»¬å°†å¼€å‘ä¸€ä¸ª Web æ¡†æ¶ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå…ˆå›é¡¾ä¸€ä¸‹å‘½åç©ºé—´ã€å’Œ sstream å­—ç¬¦ä¸² IO æµçš„ç›¸å…³çŸ¥è¯†ã€‚å¦‚æœå¯¹è¿™éƒ¨åˆ†æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡æœ¬å°èŠ‚ã€‚

### å‘½åç©ºé—´

åœ¨å¼€å‘åº“æ—¶ï¼Œåº“é€šå¸¸ä¼šæœ‰å®šä¹‰å¤§é‡çš„å…¨å±€åç§°ï¼Œè¿™æ—¶å€™å½“æˆ‘ä»¬ä½¿ç”¨çš„åº“è¶Šæ¥è¶Šå¤šæ—¶ï¼Œå°±ä¸å¯é¿å…çš„å‘ç”Ÿåç§°å†²çªçš„æƒ…å†µï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å‘½åç©ºé—´æ±¡æŸ“ã€‚

åœ¨å‘½åç©ºé—´è¯ç”Ÿä»¥å‰ï¼Œé€šå¸¸ä½¿ç”¨çš„åŠæ³•å°±æ˜¯æŠŠä¸€ä¸ªå‡½æ•°ã€ç±»ã€ç”šè‡³å˜é‡åç­‰åå­—å–å¾—è¶³å¤Ÿé•¿ï¼Œåœ¨æ¯ä¸€ä¸ªåå­—çš„å‰é¢éƒ½å¢åŠ ç›¸åº”çš„å‰ç¼€ï¼Œä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬åªæƒ³è¦å®šä¹‰ä¸€ä¸ª port çš„å˜é‡æ—¶å€™ï¼š

```cpp
// åŸæœ¬çš„æ ·å­
int port;
// å®é™…çš„æ ·å­
int shiyanlou_web_server_port;
```

å‘½åç©ºé—´çš„å®šä¹‰éå¸¸ç®€å•ï¼Œé€šè¿‡å…³é”®å­— `namespace` åŠ ä¸Šå‘½åç©ºé—´çš„åå­—ï¼Œå†ä½¿ç”¨èŠ±æ‹¬å·åŒ…è£¹éœ€è¦çš„å®šä¹‰å’Œå£°æ˜å³å¯å®Œæˆç›¸å…³çš„å®šä¹‰ï¼Œä¾‹å¦‚ï¼š

```cpp
namespace shiyanlou_web_server {
    int port = 0;
}
```

è¿™æ—¶ï¼Œè¿™ä¸ª `port` å°±è¢«é™åˆ¶åœ¨äº†å‘½åç©ºé—´ `shiyanlou_web_server` å½“ä¸­ï¼Œå¦‚æœä¸é€šè¿‡å‘½åç©ºé—´çš„æŒ‡å®šï¼Œå°±ä¸ä¼šè¢«è®¿é—®åˆ°ã€‚

å‚è€ƒä¸‹é¢çš„ä¾‹å­ï¼š

```cpp
//
// main.cpp
//
#include &lt;iostream&gt;
#include &#34;web.hpp&#34;
#include &#34;web2.hpp&#34;
int main() {
    std::cout &lt;&lt; &#34;hello world!&#34; &lt;&lt; std::endl;
    std::cout &lt;&lt; &#34;shiyanlou_web_server, port=&#34; &lt;&lt; shiyanlou_web_server::port &lt;&lt; std::endl;
    std::cout &lt;&lt; &#34;shiyanlou_web2_server, port=&#34; &lt;&lt; shiyanlou_web2_server::port &lt;&lt; std::endl;
    return 0;
}
```

```cpp
// 
// web.hpp
//
namespace shiyanlou_web_server{
    int port = 0;
}
```

```cpp
//
// web2.hpp
//
namespace shiyanlou_web2_server{
    int port = 2;
}
```

æœ€åçš„è¾“å‡ºç»“æœä¸ºï¼š

```
hello world!
shiyanlou_web_server, port=0
shiyanlou_web2_server, port=2
```

### å¸¸ç”¨ IO åº“

æˆ‘ä»¬å¸¸è¯´çš„ C++ IO åº“ä¸€èˆ¬æŒ‡ `iostream`, `fstream`, `sstream`ã€‚

- iostream åŒ…å«äº† `istream`(ä»æµè¯»)/`ostream`(ä»æµå†™)/`iostream`(è¯»å†™æµ)
- fstream åŒ…å«äº† `ifstream`(ä»æ–‡ä»¶è¯»)/`ofstream`(condition æ–‡ä»¶å†™)/`fstream`(è¯»å†™æ–‡ä»¶)
- sstream åŒ…å«äº† `istringstream`(ä» string è¯»)/`ostringstream`(å‘ string å†™)/`stringstream`(è¯»å†™ string)

&gt; å…¶å®æ ‡å‡†åº“è¿˜æœ‰å®½å­—ç¬¦ç‰ˆæœ¬ï¼Œä½†æˆ‘ä»¬è¿™é‡Œä¸è®¨è®ºï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥å‚è€ƒå‚è€ƒé“¾æ¥ã€‚

`iostream` å’Œ `fstream` æ˜¯ä¸¤ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„IO åº“ï¼Œæˆ‘ä»¬è¿™é‡Œä¸å†å›é¡¾ï¼Œè¿™é‡Œç®€å•å›é¡¾ä¸€ä¸‹ `sstream`ã€‚

å¦‚æœä½ ç†Ÿæ‚‰ C è¯­è¨€ï¼Œå°±çŸ¥é“å°† int è½¬æ¢ä¸º string ç±»å‹å…¶å®æ˜¯ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹æƒ…ï¼Œè™½ç„¶æ ‡å‡†åº“ä¸­æä¾›äº† `itoa()` è¿™ç§å‡½æ•°ï¼Œä½†æ˜¯ä¾ç„¶éœ€è¦å¯¹è½¬æ¢åçš„ C é£æ ¼å­—ç¬¦ä¸²(char *)é€šè¿‡ std::string çš„æ„é€ å‡½æ•°æ„é€ ä¸º std::stringã€‚
å¦‚æœä½¿ç”¨æµæ“ä½œï¼Œé‚£ä¹ˆè¿™å°†å˜å¾—å¼‚å¸¸çš„ç®€å•ï¼š

```cpp
#include &lt;string&gt;
#include &lt;sstream&gt;
#include &lt;iostrea&gt;

int main() {
    // std::stringstream æ”¯æŒè¯»å†™
    std::stringstream stream;
    std::string result;
    int number = 12345;
    stream &lt;&lt; number;   // å°† number è¾“å…¥åˆ° stream
    stream &gt;&gt; results;  // ä» stream è¯»å–åˆ° result
    std::cout &lt; result &lt;&lt; std::endl; // å°†è¾“å‡ºä¸ºå­—ç¬¦ä¸²&#34;12345&#34;
}
```

å¦‚æœå¸Œæœ›è®©sstream å’Œ C é£æ ¼çš„å­—ç¬¦ä¸²æ‰“äº¤é“ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ï¼š

```cpp
#include &lt;sstream&gt;
#include &lt;iostream&gt; 

int main()
{
    std::stringstream stream;
    char result[6];
    stream &lt;&lt; 12345;
    stream &gt;&gt; result;
    std::cout &lt;&lt; result &lt;&lt; std::endl;
} 
```

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼Œåœ¨è¿›è¡Œå¤šæ¬¡IO æ“ä½œæ—¶ï¼Œå¦‚æœå¸Œæœ›ç»“æœå½¼æ­¤ä¸å½±å“ï¼Œéœ€è¦å¯¹ stream å¯¹è±¡è¿›è¡Œä¸€æ¬¡ `clear()` æ“ä½œï¼š

```cpp
stream.clear()
```

## äºŒã€C++11 ç›¸å…³

C++11 å‡ ä¹é‡æ–°å®šä¹‰äº† C++ çš„ä¸€åˆ‡ï¼ŒC++11 çš„å‡ºç°ä¼´éšç€å¤§é‡çš„æœ‰ç”¨çš„æ–°ç‰¹æ€§å’Œæ ‡å‡†åº“ï¼Œè¿™äº›ç‰¹æ€§å’Œæ ‡å‡†ä½¿å¾— C++ å˜å¾—æ›´åŠ ç°ä»£ï¼Œç”šè‡³åœ¨ç¼–ç èŒƒå¼ä¸Šéƒ½ä¸ä¼ ç»Ÿ C++ æœ‰ç€æœ¬è´¨ä¸Šçš„å·®å¼‚ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°†å›é¡¾ä¸€ä¸‹è¿™äº›ç‰¹æ€§ï¼š

- lambda expression
- std::shared_ptr
- std::make_shared
- std::unordered_map
- std::regex
- std::smatch
- std::regex_match
- std::function
- std::thread

å¦‚æœå¯¹è¿™äº›ç‰¹æ€§æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡æœ¬èŠ‚ã€‚

### lambda è¡¨è¾¾å¼

Lambda è¡¨è¾¾å¼æ˜¯ C++11ä¸­æœ€é‡è¦çš„æ–°ç‰¹æ€§ä¹‹ä¸€ï¼Œè€Œ Lambda è¡¨è¾¾å¼ï¼Œå®é™…ä¸Šå°±æ˜¯æä¾›äº†ä¸€ä¸ªç±»ä¼¼åŒ¿åå‡½æ•°çš„ç‰¹æ€§ï¼Œè€ŒåŒ¿åå‡½æ•°åˆ™æ˜¯åœ¨éœ€è¦ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯åˆä¸æƒ³è´¹åŠ›å»å‘½åä¸€ä¸ªå‡½æ•°çš„æƒ…å†µä¸‹å»ä½¿ç”¨çš„ã€‚è¿™æ ·çš„åœºæ™¯å…¶å®æœ‰å¾ˆå¤šå¾ˆå¤šï¼Œæ‰€ä»¥åŒ¿åå‡½æ•°å‡ ä¹æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€çš„æ ‡é…ã€‚

Lambda è¡¨è¾¾å¼çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```
[æ•è·åˆ—è¡¨](å‚æ•°åˆ—è¡¨) mutable(å¯é€‰) å¼‚å¸¸å±æ€§ -&gt; è¿”å›ç±»å‹ {
    // å‡½æ•°ä½“
}
```

ä¸Šé¢çš„è¯­æ³•è§„åˆ™é™¤äº† `[æ•è·åˆ—è¡¨]` å†…çš„ä¸œè¥¿å¤–ï¼Œå…¶ä»–éƒ¨åˆ†éƒ½å¾ˆå¥½ç†è§£ï¼Œåªæ˜¯ä¸€èˆ¬å‡½æ•°çš„å‡½æ•°åè¢«ç•¥å»ï¼Œè¿”å›å€¼ä½¿ç”¨äº†ä¸€ä¸ª `-&gt;` çš„å½¢å¼è¿›è¡Œã€‚

æ‰€è°“æ•è·åˆ—è¡¨ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºå‚æ•°çš„ä¸€ç§ç±»å‹ï¼Œlambda è¡¨è¾¾å¼å†…éƒ¨å‡½æ•°ä½“åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸èƒ½å¤Ÿä½¿ç”¨å‡½æ•°ä½“å¤–éƒ¨çš„å˜é‡çš„ï¼Œè¿™æ—¶å€™æ•è·åˆ—è¡¨å¯ä»¥èµ·åˆ°ä¼ é€’å¤–éƒ¨æ•°æ®çš„ä½œç”¨ã€‚æ ¹æ®ä¼ é€’çš„è¡Œä¸ºï¼Œæ•è·åˆ—è¡¨ä¹Ÿåˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š

**1. å€¼æ•è·**

ä¸å‚æ•°ä¼ å€¼ç±»ä¼¼ï¼Œå€¼æ•è·çš„å‰æœŸæ˜¯å˜é‡å¯ä»¥æ‹·è´ï¼Œä¸åŒä¹‹å¤„åˆ™åœ¨äºï¼Œè¢«æ•è·çš„å˜é‡åœ¨ lambda è¡¨è¾¾å¼è¢«åˆ›å»ºæ—¶æ‹·è´ï¼Œè€Œéè°ƒç”¨æ—¶æ‰æ‹·è´ï¼š

```cpp
void learn_lambda_func_1() {
    int value_1 = 1;
    auto copy_value_1 = [value_1] {
        return value_1;
    };
    value_1 = 100;
    auto stored_value_1 = copy_value_1();
    // è¿™æ—¶, stored_value_1 == 1, è€Œ value_1 == 100.
    // å› ä¸º copy_value_1 åœ¨åˆ›å»ºæ—¶å°±ä¿å­˜äº†ä¸€ä»½ value_1 çš„æ‹·è´
}
```

**2. å¼•ç”¨æ•è·**

ä¸å¼•ç”¨ä¼ å‚ç±»ä¼¼ï¼Œå¼•ç”¨æ•è·ä¿å­˜çš„æ˜¯å¼•ç”¨ï¼Œå€¼ä¼šå‘ç”Ÿå˜åŒ–ã€‚

```cpp
void learn_lambda_func_2() {
    int value_2 = 1;
    auto copy_value_2 = [&amp;value_2] {
        return value_2;
    };
    value_2 = 100;
    auto stored_value_2 = copy_value_2();
    // è¿™æ—¶, stored_value_2 == 100, value_1 == 100.
    // å› ä¸º copy_value_2 ä¿å­˜çš„æ˜¯å¼•ç”¨
}
```

**3. éšå¼æ•è·**

æ‰‹åŠ¨ä¹¦å†™æ•è·åˆ—è¡¨æœ‰æ—¶å€™æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™ç§æœºæ¢°æ€§çš„å·¥ä½œå¯ä»¥äº¤ç»™ç¼–è¯‘å™¨æ¥å¤„ç†ï¼Œè¿™æ—¶å€™å¯ä»¥åœ¨æ•è·åˆ—è¡¨ä¸­å†™ä¸€ä¸ª `&amp;` æˆ– `=` å‘ç¼–è¯‘å™¨å£°æ˜é‡‡ç”¨ å¼•ç”¨æ•è·æˆ–è€…å€¼æ•è·.

æ€»ç»“ä¸€ä¸‹ï¼Œæ•è·æä¾›äº†lambda è¡¨è¾¾å¼å¯¹å¤–éƒ¨å€¼è¿›è¡Œä½¿ç”¨çš„åŠŸèƒ½ï¼Œæ•è·åˆ—è¡¨çš„æœ€å¸¸ç”¨çš„å››ç§å½¢å¼å¯ä»¥æ˜¯ï¼š

- [] ç©ºæ•è·åˆ—è¡¨
- [name1, name2, ...] æ•è·ä¸€ç³»åˆ—å˜é‡
- [&amp;] å¼•ç”¨æ•è·, è®©ç¼–è¯‘å™¨è‡ªè¡Œæ¨å¯¼æ•è·åˆ—è¡¨
- [=] å€¼æ•è·, è®©ç¼–è¯‘å™¨æ‰§è¡Œæ¨å¯¼åº”ç”¨åˆ—è¡¨

#### std::shared_ptr, std::make_shared

C++11 åœ¨å†…å­˜ç®¡ç†ä¸ŠåŒæ ·åšäº†å¾ˆå¤šæ”¹è¿›ï¼Œstd::make_shared å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚å®ƒæ˜¯å’Œ `std::shared_ptr` å…±åŒå‡ºç°çš„ï¼Œ`std::shared_ptr` æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒèƒ½å¤Ÿè®°å½•å¤šå°‘ä¸ª shared_ptr å…±åŒæŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼ˆç†Ÿæ‚‰ Objective-C çš„å¯èƒ½çŸ¥é“ï¼Œè¿™ç§ç‰¹æ€§å«åšå¼•ç”¨è®¡æ•°ï¼‰ï¼Œèƒ½å¤Ÿæ¶ˆé™¤æ˜¾ç¤ºçš„è°ƒç”¨ `delete`ï¼Œå½“å¼•ç”¨è®¡æ•°å˜ä¸º0çš„æ—¶å€™å°±ä¼šå°†å¯¹è±¡è‡ªåŠ¨åˆ é™¤ã€‚

ä½†è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä½¿ç”¨ `std::shared_ptr` ä»ç„¶éœ€è¦ä½¿ç”¨ newæ¥è°ƒç”¨ï¼Œè¿™ä½¿å¾—ä»£ç å‡ºç°äº†æŸç§ç¨‹åº¦ä¸Šçš„ä¸å¯¹ç§°ã€‚å› æ­¤å°±éœ€è¦å¦ä¸€ç§æ‰‹æ®µ(å·¥å‚æ¨¡å¼)æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

`std::make_shared` å°±èƒ½å¤Ÿç”¨æ¥æ¶ˆé™¤æ˜¾ç¤ºçš„ä½¿ç”¨ `new`ï¼Œæ‰€ä»¥`std::make_shared` ä¼šåˆ†é…åˆ›å»ºä¼ å…¥å‚æ•°ä¸­çš„å¯¹è±¡ï¼Œå¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ç±»å‹çš„`std::shared_ptr`æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼š

```
#include &lt;iostream&gt;
#include &lt;memory&gt;
 
void foo(std::shared_ptr&lt;int&gt; i)
{
    (*i)++;
}
int main()
{
    // æ„é€ äº†ä¸€ä¸ª std::shared_ptr
    auto pointer = std::make_shared&lt;int&gt;(10);
    foo(pointer);
    std::cout &lt;&lt; *pointer &lt;&lt; std::endl;
}
```

### æ— åºå®¹å™¨ std::unordered_map

åœ¨ä¼ ç»Ÿçš„ C++ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç†ŸçŸ¥äº† std::map å…³è”å®¹å™¨ï¼Œstd::map å®¹å™¨åœ¨æ’å…¥å…ƒç´ æ—¶ï¼Œä¼šæ ¹æ® `&lt;` æ“ä½œç¬¦æ¯”è¾ƒå…ƒç´ å¤§å°å¹¶åˆ¤æ–­å…ƒç´ æ˜¯å¦ç›¸åŒï¼Œå¹¶é€‰æ‹©åˆé€‚çš„ä½ç½®æ’å…¥åˆ°å®¹å™¨ä¸­ã€‚å½“å¯¹è¿™ä¸ªå®¹å™¨ä¸­çš„å…ƒç´ è¿›è¡Œéå†æ—¶ï¼Œè¾“å‡ºç»“æœä¼šæŒ‰ç…§ `&lt;` æ“ä½œç¬¦çš„é¡ºåºæ¥é€ä¸ªéå†ã€‚

è€Œ C++11 ç»ˆäºæ¨å‡ºäº†æ— åºå®¹å™¨ã€‚ `std::unordered_map` å°±æ˜¯æ— åºå®¹å™¨å…¶ä¸­ä¹‹ä¸€ï¼Œè¿™ä¸ªå®¹å™¨ä¼šè®¡ç®—å…ƒç´ çš„ Hash å€¼ï¼Œå¹¶æ ¹æ® Hash å€¼æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦ç›¸åŒã€‚ç”±äºæ— åºå®¹å™¨æ²¡æœ‰å®šä¹‰å…ƒç´ ä¹‹é—´çš„é¡ºåºï¼Œä»…é  Hash å€¼æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦å·²ç»å­˜åœ¨äºå®¹å™¨ä¸­ï¼Œæ‰€ä»¥éå† `std::unordered_map` æ—¶ï¼Œç»“æœæ˜¯æ— åºçš„ã€‚

æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```cpp
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;unordered_map&gt;
#include &lt;map&gt;

int main() {
    // ä¸¤ç»„ç»“æ„æŒ‰åŒæ ·çš„é¡ºåºåˆå§‹åŒ–
    std::unordered_map&lt;int, std::string&gt; u = {
        {1, &#34;1&#34;},
        {3, &#34;3&#34;},
        {2, &#34;2&#34;}
    };
    std::map&lt;int, std::string&gt; v = {
        {1, &#34;1&#34;},
        {3, &#34;3&#34;},
        {2, &#34;2&#34;}
    };
    
    // åˆ†åˆ«å¯¹ä¸¤ç»„ç»“æ„è¿›è¡Œéå†
    std::cout &lt;&lt; &#34;std::unordered_map&#34; &lt;&lt; std::endl;
    for( const auto &amp; n : u) 
        std::cout &lt;&lt; &#34;Key:[&#34; &lt;&lt; n.first &lt;&lt; &#34;] Value:[&#34; &lt;&lt; n.second &lt;&lt; &#34;]\n&#34;;
        
    std::cout &lt;&lt; std::endl;
    std::cout &lt;&lt; &#34;std::map&#34; &lt;&lt; std::endl;
    for( const auto &amp; n : v) 
        std::cout &lt;&lt; &#34;Key:[&#34; &lt;&lt; n.first &lt;&lt; &#34;] Value:[&#34; &lt;&lt; n.second &lt;&lt; &#34;]\n&#34;;
}
```

æœ€ç»ˆçš„è¾“å‡ºç»“æœä¸ºï¼š

```
std::unordered_map
Key:[2] Value:[2]
Key:[3] Value:[3]
Key:[1] Value:[1]

std::map
Key:[1] Value:[1]
Key:[2] Value:[2]
Key:[3] Value:[3]
```

å¯ä»¥çœ‹åˆ° `std::map` çš„éå†ç»“æœæ˜¯æœ‰åºçš„ï¼Œè€Œ `std::unordered_map` çš„éå†ç»“æœæ˜¯æ— åºçš„ã€‚

äº‹å®ä¸Šï¼Œ`std::unordered_map` åœ¨å•ä¸ªå…ƒç´ è®¿é—®æ—¶ï¼Œæ€»æ˜¯èƒ½å¤Ÿè·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚

### std::regex/std::regex_match/std::smatch

æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªç‹¬ç«‹äº C++ è¯­è¨€æœ¬èº«çš„å¦ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œæˆ‘ä»¬è¿™é‡Œä¸è¯¦ç»†è®¨è®ºå®ƒçš„è¡Œä¸ºã€‚

ä½œä¸ºå­¦ä¹  `std::regex` çš„ä¸€äº›ä»‹ç»æ€§å†…å®¹ï¼Œæˆ‘ä»¬è¿™é‡Œè¯´æ˜ä¸€ä¸‹æ¥ä¸‹æ¥ä¼šç”¨åˆ°çš„ä¸€äº›æ­£åˆ™è¡¨è¾¾å¼ï¼š

- `[a-z]+\.txt`: åœ¨è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¸­, `[a-z]` è¡¨ç¤ºåŒ¹é…ä¸€ä¸ªå°å†™å­—æ¯, `+` å¯ä»¥ä½¿å‰é¢çš„è¡¨è¾¾å¼åŒ¹é…å¤šæ¬¡ï¼Œå› æ­¤ `[a-z]+` èƒ½å¤ŸåŒ¹é…ä¸€ä¸ªå°å†™å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ã€‚åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ä¸€ä¸ª `.` è¡¨ç¤ºåŒ¹é…ä»»æ„å­—ç¬¦ï¼Œè€Œ `\.` åˆ™è¡¨ç¤ºåŒ¹é…å­—ç¬¦ `.`ï¼Œæœ€åçš„ `txt` è¡¨ç¤ºä¸¥æ ¼åŒ¹é… `txt` åˆ™ä¸‰ä¸ªå­—æ¯ã€‚å› æ­¤è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„æ‰€è¦åŒ¹é…çš„å†…å®¹å°±æ˜¯ç”±çº¯å°å†™å­—æ¯ç»„æˆçš„æ–‡æœ¬æ–‡ä»¶ã€‚

`std::regex_match` ç”¨äºåŒ¹é…å­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œæœ‰å¾ˆå¤šä¸åŒçš„é‡è½½å½¢å¼ã€‚æœ€ç®€å•çš„ä¸€ä¸ªå½¢å¼å°±æ˜¯ä¼ å…¥`std::string` ä»¥åŠä¸€ä¸ª `std::regex` è¿›è¡ŒåŒ¹é…ï¼Œå½“åŒ¹é…æˆåŠŸæ—¶ï¼Œä¼šè¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`ã€‚ä¾‹å¦‚ï¼š

```cpp
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;regex&gt;

int main() {
    std::string fnames[] = {&#34;foo.txt&#34;, &#34;bar.txt&#34;, &#34;test&#34;, &#34;a0.txt&#34;, &#34;AAA.txt&#34;};
    // åœ¨ C++ ä¸­ `\` ä¼šè¢«ä½œä¸ºå­—ç¬¦ä¸²å†…çš„è½¬ä¹‰ç¬¦ï¼Œä¸ºä½¿ `\.` ä½œä¸ºæ­£åˆ™è¡¨è¾¾å¼ä¼ é€’è¿›å»ç”Ÿæ•ˆï¼Œéœ€è¦å¯¹ `\` è¿›è¡ŒäºŒæ¬¡è½¬ä¹‰ï¼Œä»è€Œæœ‰ `\\.`
    std::regex txt_regex(&#34;[a-z]+\\.txt&#34;);
    for (const auto &amp;fname: fnames)
        std::cout &lt;&lt; fname &lt;&lt; &#34;: &#34; &lt;&lt; std::regex_match(fname, txt_regex) &lt;&lt; std::endl;
}
```

å¦ä¸€ç§å¸¸ç”¨çš„å½¢å¼å°±æ˜¯ä¾æ¬¡ä¼ å…¥ `std::string`/`std::smatch`/`std::regex` ä¸‰ä¸ªå‚æ•°ï¼Œå…¶ä¸­ `std::smatch` çš„æœ¬è´¨å…¶å®æ˜¯ `std::match_results`ï¼Œåœ¨æ ‡å‡†åº“ä¸­ï¼Œ `std::smatch` è¢«å®šä¹‰ä¸ºäº† `std::match_results&lt;std::string::const_iterator&gt;`ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå­ä¸²è¿­ä»£å™¨ç±»å‹çš„ `match_results`ã€‚ä½¿ç”¨ `std::smatch` å¯ä»¥æ–¹ä¾¿çš„å¯¹åŒ¹é…çš„ç»“æœè¿›è¡Œè·å–ï¼Œä¾‹å¦‚ï¼š

```cpp
std::regex base_regex(&#34;([a-z]+)\\.txt&#34;);
std::smatch base_match;
for(const auto &amp;fname: fnames) {
    if (std::regex_match(fname, base_match, base_regex)) {
        // sub_match çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²
        // sub_match çš„ç¬¬äºŒä¸ªå…ƒç´ åŒ¹é…äº†ç¬¬ä¸€ä¸ªæ‹¬å·è¡¨è¾¾å¼
        if (base_match.size() == 2) {
            std::string base = base_match[1].str();
            std::cout &lt;&lt; &#34;sub-match[0]: &#34; &lt;&lt; base_match[0].str() &lt;&lt; std::endl;
            std::cout &lt;&lt; fname &lt;&lt; &#34; sub-match[1]: &#34; &lt;&lt; base &lt;&lt; std::endl;
        }
    }
}
```

ä»¥ä¸Šä¸¤ä¸ªä»£ç æ®µçš„è¾“å‡ºç»“æœä¸ºï¼š

```
foo.txt: 1
bar.txt: 1
test: 0
a0.txt: 0
AAA.txt: 0
sub-match[0]: foo.txt
foo.txt sub-match[1]: foo
sub-match[0]: bar.txt
bar.txt sub-match[1]: bar
```

### std::function

`std::function` æ˜¯ä¸€ç§é€šç”¨ã€å¤šæ€çš„å‡½æ•°å°è£…ï¼Œå®ƒçš„å®ä¾‹å¯ä»¥å¯¹ä»»ä½•å¯ä»¥è°ƒç”¨çš„ç›®æ ‡å®ä½“è¿›è¡Œå­˜å‚¨ã€å¤åˆ¶å’Œè°ƒç”¨æ“ä½œï¼Œå®ƒä¹Ÿæ˜¯å¯¹ C++ä¸­ç°æœ‰çš„å¯è°ƒç”¨å®ä½“çš„ä¸€ç§ç±»å‹å®‰å…¨çš„åŒ…è£¹ï¼ˆç›¸å¯¹æ¥è¯´ï¼Œå‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼‰ï¼Œç®€è€Œè¨€ä¹‹ï¼Œ`std::function` å°±æ˜¯å‡½æ•°çš„å®¹å™¨ã€‚

åœ¨å‰é¢çš„ Lambda è¡¨è¾¾å¼ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»è¿‡ä½¿ç”¨ `auto` å…³é”®å­—æ¥æ¥å—ä¸€ä¸ª lambda è¡¨è¾¾å¼ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½å¸Œæœ›æ˜ç¡®çš„æŒ‡æ˜è¿™ä¸ª lambda è¡¨è¾¾å¼çš„ç±»å‹ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨ `std::function` æ¥è¿›è¡Œä¹¦å†™ï¼Œä¾‹å¦‚ï¼š

```cpp
#include &lt;functional&gt;
#include &lt;iostream&gt;

int foo(int para) {
    return para;
}

int main() {
    // std::function åŒ…è£…äº†ä¸€ä¸ªè¿”å›å€¼ä¸º int, å‚æ•°ä¸º int çš„å‡½æ•°
    std::function&lt;int(int)&gt; func = foo;
    std::cout &lt;&lt; func(10) &lt;&lt; std::endl;
}
```

### std::thread

`std::thread` ç”¨äºåˆ›å»ºä¸€ä¸ªæ‰§è¡Œçš„çº¿ç¨‹å®ä¾‹ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€åˆ‡å¹¶å‘ç¼–ç¨‹çš„åŸºç¡€ï¼Œä½¿ç”¨æ—¶éœ€è¦åŒ…å«&lt;thread&gt;å¤´æ–‡ä»¶ï¼Œå®ƒæä¾›äº†å¾ˆå¤šåŸºæœ¬çš„çº¿ç¨‹æ“ä½œï¼Œä¾‹å¦‚`get_id()`æ¥è·å–æ‰€åˆ›å»ºçº¿ç¨‹çš„çº¿ç¨‹ IDï¼Œä¾‹å¦‚ä½¿ç”¨ `join()` æ¥ç­‰å¾…çº¿ç¨‹ç­‰ç­‰ï¼Œä¾‹å¦‚ï¼š

```cpp
#include &lt;iostream&gt;
#include &lt;thread&gt;
void foo() {
    std::cout &lt;&lt; &#34;hello world&#34; &lt;&lt; std::endl;
}
int main() {
    std::thread t(foo);
    t.join();
    return 0;
}
```

## ä¸‰ã€Boost Asio ç›¸å…³

Boost æ˜¯ä¸€ä¸ª C++çš„å¯ç§»æ¤åº“ï¼Œæ˜¯å¯¹æ ‡å‡†åº“çš„åå¤‡æ‰©å±•ï¼Œä¹Ÿæ˜¯ C++æ ‡å‡†åŒ–è¿›ç¨‹çš„å¼€å‘å¼•æ“ä¹‹ä¸€ã€‚Boost åº“æ˜¯ç”± C++æ ‡å‡†å§”å‘˜ä¼šçš„æˆå‘˜å‘èµ·çš„ï¼Œé‡Œé¢å‘å±•çš„å†…å®¹å¾ˆæœ‰å¯èƒ½ä¼šæˆä¸º C++æ ‡å‡†åº“çš„å†…å®¹ä¹‹ä¸€ã€‚å› æ­¤ Boost ä¹Ÿæ˜¯ C++ç¤¾åŒºä¸­å½±å“åŠ›æœ€å¤§çš„ ã€å‡†ã€æ ‡å‡†åº“ã€‚

Boost Asioï¼Œå°±æ˜¯ Boost åº“ä¸­çš„ä¸€ä¸ªéƒ¨åˆ†ï¼ŒAsio çš„å…¨ç§°ä¸º Asynchronous input and output ï¼ˆå¼‚æ­¥è¾“å…¥è¾“å‡ºï¼‰çš„ç¼©å†™ã€‚é¡¾åæ€ä¹‰ï¼Œç»“åˆ Boost çš„ç‰¹ç‚¹ï¼ŒAsio æä¾›äº†ä¸€å¥—å¹³å°æ— å…³çš„å¼‚æ­¥æ•°æ®å¤„ç†èƒ½åŠ›ï¼ˆå½“ç„¶å®ƒä¹Ÿæ”¯æŒåŒæ­¥æ•°æ®å¤„ç†ï¼‰ã€‚

æœ¬èŠ‚æˆ‘ä»¬å°†ç†Ÿæ‚‰ä¸€ä¸‹ä¸‹é¢è¿™äº›çŸ¥è¯†ç‚¹çš„ç”¨æ³•ï¼Œå¦‚æœä½ å¯¹è¿™äº›å†…å®¹æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡æœ¬èŠ‚ã€‚

- boost::asio::io_service
- boost::asio::ip::tcp::socket
- boost::asio::ip::tcp::v4()
- boost::asio::ip::tcp::endpoint
- boost::asio::ip::tcp::acceptor
- boost::asio::streambuf
- boost::asio::async_read
- boost::asio::async_read_until
- boost::asio::async_write
- boost::asio::transfer_exactly
- boost::asio::ssl::stream
- boost::asio::ssl::stream_base::server
- boost::asio::ssl::context
- boost::asio::ssl::context::sslv23
- boost::asio::ssl::context::pem
- boost::system::error_code

ä½¿ç”¨ Asio åªéœ€è¦å¼•å…¥ä¸€ä¸ªå¤´æ–‡ä»¶å³å¯ï¼š

```cpp
#include &lt;boost/asio.hpp&gt;
```

å¯¹äºæ‰€æœ‰ä½¿ç”¨ Asio çš„ç¨‹åºï¼Œéƒ½å¿…é¡»è¦åŒ…å«è‡³å°‘ä¸€ä¸ª `io_service` å¯¹è±¡ã€‚å¯¹äº Asio è¿™ä¸ª Boost åº“è€Œè¨€ï¼Œå®ƒæŠ½è±¡äº†è¯¸å¦‚ç½‘ç»œã€ä¸²å£é€šä¿¡ç­‰ç­‰è¿™äº›æ¦‚å¿µï¼Œå¹¶å°†å…¶ç»Ÿä¸€è§„ä¸º IO æ“ä½œï¼Œæ‰€ä»¥ `io_service` è¿™ä¸ªç±»æä¾›äº†è®¿é—® I/O çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œä½¿ç”¨ Asio æ—¶ï¼Œå¿…é¡»å®šä¹‰ï¼š

```cpp
boost::asio::io_service io;
```

### HTTP è¿æ¥

æ—¢ç„¶ç½‘ç»œçš„ç›¸å…³æ¦‚å¿µå·²ç»è¢«æŠ½è±¡ä¸º IOï¼Œæˆ‘ä»¬å°±åªéœ€è¦å…³å¿ƒä»è¿™ä¸ª IO æµä¸­è·å–æ¶ˆæ¯ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šè¿˜æ˜¯åœ¨è¿›è¡Œ IO æ“ä½œï¼Œåªä¸è¿‡è¿™ä¸ªæ“ä½œéœ€è¦å…·å¤‡ä¸€äº›åŸºæœ¬çš„ç½‘ç»œæ¦‚å¿µã€‚

æˆ‘ä»¬çŸ¥é“ï¼ŒHTTP å’Œ HTTPS çš„åº•å±‚å®é™…ä¸Šæ˜¯ä½¿ç”¨çš„ TCP å¯é è¿æ¥ï¼Œé€šè¿‡ Socket æŠ€æœ¯è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸€ä¸ª Socket ç”± IP åœ°å€åŠç«¯å£æ„æˆã€‚æ— ä¾‹å¤–åœ°ï¼ŒAsio åŒæ ·ä¹Ÿéœ€è¦å»ºç«‹ä¸€ä¸ªå’Œ socket æœ‰å…³çš„å¯¹è±¡ï¼Œé‚£å°±æ˜¯ `boost::asio::ip::tcp::socket`ã€‚å¯æƒ³è€ŒçŸ¥ï¼ŒSocket æ—¢ç„¶æ˜¯ç½‘ç»œé€šä¿¡çš„åŸºç¡€ï¼Œé‚£ä¹ˆè‡ªç„¶çš„æˆ‘ä»¬è¦è¿›è¡Œçš„ IO æ“ä½œä¹Ÿå°±å¿…é¡»åœ¨è¿™é‡Œå®Œæˆï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å®šä¹‰çš„ `boost::asio::ip::tcp::socket` å¯¹è±¡ï¼Œå¿…é¡»ç”± `io_service` æ¥è¿›è¡Œæ„é€ ï¼Œå³ï¼š

```cpp
boost::asio::ip::tcp::socket socket(io);
```

æœ‰äº† socket å¯¹è±¡æ˜¯ä¸å¤Ÿçš„ã€‚åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œç½‘ç»œ IO å°±å…¥å£ä¸²å£ä¸€æ ·ï¼Œæ˜¯ä»¥æµçš„æ–¹å¼è¿›è¡Œçš„ã€‚æ‰€ä»¥è¿™ä¸ª socket å¯¹è±¡åªèƒ½ç”¨æ¥åšæˆ‘ä»¬æ—¥åè¿›è¡Œ IO æ“ä½œæ—¶çš„ä¸€ä¸ªå¿…è¦å±æ€§ã€‚

ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ªæ™®é€šçš„ `boost::asio::ip::tcp::socket` å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª HTTP çš„ Socket è¿æ¥ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ—¥åè¿›è¡Œä»£ç ç¼–å†™æ—¶ï¼Œç”šè‡³äºå¯ä»¥ä½¿ç”¨ `typedef` å°†è¿™ä¸ªç±»å‹ç›´æ¥å®šä¹‰ä¸º `HTTP`:

```cpp
typedef boost::asio::ip::tcp::socket HTTP;
```

ç„¶è€Œï¼Œä½œä¸ºæœåŠ¡ç«¯ï¼Œæˆ‘ä»¬å¯èƒ½æ„å»ºå¾ˆå¤šå¾ˆå¤šçš„è¿æ¥ä»è€Œå“åº”å¹¶å‘ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å»ºç«‹è¿æ¥æ—¶å€™ï¼Œå°±éœ€è¦ä½¿ç”¨ä¸€ä¸ªå«åš `acceptor` çš„å¯¹è±¡ã€‚

è€Œ `boost::asio::ip::tcp::acceptor` ä»åå­—ä¸Šå°±å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå¯¹è±¡åº”è¯¥è¢«ç”¨äºå»ºç«‹è¿æ¥ã€‚åœ¨ Boost ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–ä¸€ä¸ª `acceptor` å¯¹è±¡æ—¶ï¼Œå¿…é¡»æä¾›ä¸€ä¸ª `io_service` å¯¹è±¡å’Œä¸€ä¸ª `endpoint` å¯¹è±¡ã€‚

é‚£ä¹ˆ `endpoint` åˆæ˜¯ä»€ä¹ˆï¼Ÿäº‹å®ä¸Šï¼Œsocket æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„è¿æ¥ï¼Œæ‰€è°“ `endpoint` å°±æ˜¯ socket ä½äºæœåŠ¡ç«¯çš„ä¸€ä¸ªç«¯ç‚¹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œsocket æ˜¯ç”± IP åœ°å€å’Œç«¯å£å·ç»„æˆçš„ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬éœ€è¦ä¸ºå…¶å»ºç«‹ä¸€ä¸ª IPv4 çš„ç½‘ç»œï¼Œé¦–å…ˆå¯ä»¥å»ºç«‹ä¸€ä¸ª `boost::asio::ip::tcp::endpoint` å¯¹è±¡ï¼š

```cpp
unsigned short port = 8080;
boost::asio::ip::tcp::endpoint endpoint(boost::asio::ip::tcp::v4(), port);
```

å…¶ä¸­ `boost::asio::ip::tcp::v4()` ç”¨äºåˆå§‹åŒ–ä¸€ä¸ª IPv4 çš„ç½‘ç»œã€‚æœ€ååœ¨ä½¿ç”¨è¿™ä¸ª `endpoint` å¯¹è±¡æ¥åˆå§‹åŒ– `acceptor`:

```cpp
boost::asio::ip::tcp::acceptor acceptor(io, endpoint);
```

è‡³æ­¤ï¼Œæˆ‘ä»¬è®¨è®ºäº†å¦‚ä½•ä½¿ç”¨ Asio å»ºç«‹ä¸€ä¸ªæ™®é€šçš„ç½‘ç»œæ“ä½œå¯¹è±¡ `acceptor`ï¼Œä»¥åŠåœ¨è¿›è¡Œæ™®é€š HTTP ç½‘ç»œæ“ä½œæ—¶éœ€è¦çš„ `socket` å¯¹è±¡ã€‚

### HTTPS è¿æ¥

è®¨è®ºå®Œäº† Asio é‡Œ HTTP è¿æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ Asio ä¸­çš„ HTTPS æ˜¯å¦‚ä½•å»ºç«‹è¿æ¥çš„ã€‚Asio æ˜¯ä¸€ä¸ªå¼€æºçš„åº“ï¼Œæ‰€ä»¥å®ƒä¹Ÿä¸å¯é¿å…çš„åœ¨å¤„ç†ä¸æ“…é•¿çš„é€»è¾‘æ—¶éœ€è¦æ·»åŠ å¯¹åˆ«çš„æ¡†æ¶çš„ä¾èµ–ã€‚Asio çš„ HTTPS ç›¸å…³çš„ SSL æ“ä½œï¼Œå°±ä¾èµ–äº† OpenSSL åº“ã€‚

è¦ä½¿ç”¨ SSL ç›¸å…³çš„æ“ä½œï¼Œè¿˜éœ€è¦é¢å¤–å¼•å…¥ä¸€ä¸ªå¤´æ–‡ä»¶ï¼š

```cpp
#include &lt;boost/asio/ssl.hpp&gt;
```

æˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚é‡Œè®¨è®ºäº† `boost::asio::ip::tcp::socket` äº§ç”Ÿçš„ Socket å¯¹è±¡å®é™…ä¸Šå°±æ˜¯æ™®é€šçš„ HTTP å¯¹è±¡ã€‚å¯¹äº HTTPS è€Œè¨€ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹è¿™ä¸ª socket æ‰€äº§ç”Ÿçš„é€šé“è¿›è¡Œä¸€ä¸ªä¸€å±‚å°è£…å’ŒåŠ å¯†ã€‚åœ¨ Boost Asio ä¸­ï¼ŒåŠ å¯† socket çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ `boost::asio::ssl::stream`ï¼Œå¹¶å°† `boost::asio::ip::tcp::socket` ä½œä¸ºæ¨¡æ¿å‚æ•°ä¼ å…¥ç»™è¿™ä¸ªå¯¹è±¡ï¼Œå³ï¼š

```cpp
typedef boost::asio::ssl::stream&lt;boost::asio::ip::tcp::socket&gt; HTTPS;
```

è€Œå½“æˆ‘ä»¬è¦æ„é€ ä¸€ä¸ª HTTPS çš„ socket å¯¹è±¡æ—¶ï¼ŒBoost Asio è¦æ±‚å¿…é¡»ä¸ºè¿™ä¸ª socket å»ºç«‹ä¸€ä¸ª `boost::asio::ssl::context` å¯¹è±¡ã€‚è€Œä¸€ä¸ª `context` å¯ä»¥æœ‰å¾ˆå¤šä¸åŒçš„ç±»å‹ï¼Œæœ€å¸¸ç”¨çš„ï¼Œå°±æ˜¯`boost::asio::ssl::context::sslv23`ã€‚æ„é€ å¥½äº† `context` å¯¹è±¡ä¹‹åè¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä¸€ä¸ª https çš„æœåŠ¡å™¨éœ€è¦æä¾›è¯ä¹¦æ–‡ä»¶å’Œç§˜é’¥æ–‡ä»¶ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä½¿ç”¨ `use_certificate_chain_file()` å’Œ `use_private_key_file()` è¿™ä¸¤ä¸ªæ–¹æ³•æ¥è¿›è¡Œè¿›ä¸€æ­¥çš„é…ç½®ï¼š

```cpp
context.use_certificate_chain_file(cert_file);
context.use_private_key_file(private_key_file, boost::asio::ssl::context::pem);
```

å…¶ä¸­çš„ `boost::asio::ssl::context::pem` æ˜¯æŒ‡å®šçš„è¯ä¹¦ç±»å‹ã€‚å› æ­¤ç›¸è¾ƒäº HTTP è€Œè¨€ï¼ŒHTTPS çš„å»ºç«‹å…¶å®å°±æ˜¯å¢åŠ äº†å¯¹è¯ä¹¦çš„é…ç½®ã€å’Œ socket åŠ å¯†çš„ç¯èŠ‚ï¼Œå¯¹æ¯”å¦‚ä¸‹ï¼š

```cpp
// http
boost::asio::ip::tcp::socket http_socket(io);
// https
boost::asio::ssl::context context(boost::asio::ssl::context::sslv23);
context.use_certificate_chain_file(cert_file);
context.use_private_key_file(private_key_file, boost::asio::ssl::context::pem);
boost::asio::ssl::stream&lt;boost::asio::ip::tcp::socket&gt; https_socket(io, context);
```

### IO æ“ä½œ

ä¸Šé¢æˆ‘ä»¬è®¨è®ºäº†å¦‚ä½•å»ºç«‹è¿æ¥ï¼Œç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•è¿›è¡Œ IO æ“ä½œã€‚

å½“æˆ‘ä»¬æœ‰äº† socket å¯¹è±¡ä¹‹åï¼Œå°±å¯ä»¥ä»é‡Œé¢è¯»å–ç½‘ç»œæµæ•°æ®äº†ã€‚è¯»å–æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæµç¼“å†² `boost::asio::streambuf` å¯¹è±¡ï¼Œç”¨äºé€è¡Œè¯»å– socket ä¸­çš„æ•°æ®ï¼š

```cpp
boost::asio::streambuf read_buffer;
```

å¦å¤–ï¼Œå¾ˆå¤šç½‘ç»œåè®®å…¶å®éƒ½æ˜¯åŸºäºè¡Œå®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›åè®®å…ƒç´ æ˜¯ç”± `\r\n` ç¬¦å·è¿›è¡Œç•Œå®šï¼ŒHTTP ä¹Ÿä¸ä¾‹å¤–ï¼Œæ‰€ä»¥åœ¨ Boost Asio ä¸­ï¼Œè¯»å–ä½¿ç”¨åˆ†éš”ç¬¦çš„åè®®ï¼Œå¯ä»¥ä½¿ç”¨ `async_read_untile()` æ–¹æ³•ï¼š

```cpp
boost::asio::async_read_until(socket, readbuffer, &#34;\r\n\r\n&#34;, read_handler);
```

å…¶ä¸­ socket å°±æ˜¯æˆ‘ä»¬çš„ socket è¿æ¥ï¼Œè€Œ readbuffer å°±æ˜¯æ ¹æ®ç•Œå®šç¬¦è¯»å–åˆ°çš„ä¸€è¡Œæ•°æ®ï¼Œ`&#34;\r\n\r\n&#34;` å°±æ˜¯åˆ†éš”ç¬¦ï¼Œè€Œå¯¹äº `read_handler` æˆ‘ä»¬è¿˜éœ€è¦å†è¿›ä¸€æ­¥è®¨è®ºã€‚

`read_handler` æ˜¯ä¸€ä¸ªæ— è¿”å›ç±»å‹çš„å‡½æ•°å¯¹è±¡ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ `boost::system::error_code`ï¼Œå¦ä¸€ä¸ªæ˜¯ `size_t`ï¼ˆ`bytes_transferred`ï¼‰ï¼š

```cpp
void read_handler(
    const boost::system::error_code&amp; ec,
    std::size_t bytes_transferred)
{
  ...
}
```

`boost::system::error_code` ç”¨æ¥æè¿°æ“ä½œæ˜¯å¦æˆåŠŸï¼Œè€Œ `size_t bytes_transferred ` åˆ™æ˜¯ç”¨æ¥ç¡®å®šæ¥å—åˆ°çš„å­—èŠ‚æ•°ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `std::bind` æ¥å°†å‚æ•°ç»‘å®šåˆ°æˆ‘ä»¬çš„æŸä¸ªå‡½æ•°ä¼ å…¥ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬è¿˜æœ‰æ›´å¥½çš„åšæ³•ï¼Œé‚£å°±æ˜¯ lambda è¡¨è¾¾å¼ï¼Œå› ä¸º Lambda è¡¨è¾¾å¼è¿˜å…·æœ‰å¦å¤–çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£å°±æ˜¯è¿›è¡Œå€¼æ•è·ï¼Œå¯¹äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨åé¢å®ç°æ¡†æ¶çš„æ—¶å€™å†è¯¦ç»†è®¨è®ºã€‚

åœ¨è¿™ä¸ª `read_handler` ä¸­ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨ä¸æ–­çš„è¯»å– socket é‡Œé¢çš„å†…å®¹ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨ `boost::asio::async_read` å¯¹åé¢çš„å†…å®¹è¿›è¡Œè¿›ä¸€æ­¥çš„è¯»å–ï¼Œè€Œå®ƒçš„ç”¨æ³• å’Œ `boost::asio::async_read_until` å‡ ä¹ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯åœ¨ `read_handler` è¿™ä¸ªå‚æ•°ä¹‹å‰ï¼Œéœ€è¦æŒ‡å®š è¯»å–çš„é•¿åº¦ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `boost::asio::transfer_exactly` è¿›è¡ŒæŒ‡å®šï¼Œæ•…è¿™é‡Œä¸å†è¯¦ç»†èµ˜è¿°ï¼Œæˆ‘ä»¬åœ¨åé¢å®ç°æ¡†æ¶çš„æ—¶å€™ï¼Œå†è¯¦ç»†è®¨è®ºã€‚

æœ€åï¼Œæˆ‘ä»¬å®Œæˆäº†è¯»å–çš„æ“ä½œï¼Œå°±åªå‰©ä¸‹æœ€åä¸€æ­¥äº†ï¼Œé‚£å°±æ˜¯æœåŠ¡å™¨å“åº”è¯·æ±‚ï¼Œå›å†™è¯·æ±‚çš„èµ„æºä¾›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼š`boost::asio::async_write`ã€‚ä»åå­—ä¸Šå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ–¹æ³•å’Œ `boost::asio::async_read` å±äºåŒä¸€ä¸ªæ–¹æ³•å®¶æ—ï¼Œå¯æƒ³è€ŒçŸ¥ç”¨æ³•ä¹Ÿå®Œå…¨ç±»ä¼¼ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç•™åˆ°åé¢çš„å®é™…ä»£ç ä¸­å†è¿›è¡Œè®¨è®ºã€‚

## æ€»ç»“

æœ¬èŠ‚ä¸­æˆ‘ä»¬å›é¡¾äº† C++11 çš„ç›¸å…³çŸ¥è¯†ï¼Œå¹¶å¯¹ Boost ä¸­çš„ Asio åšäº†ä¸€äº›ä»‹ç»ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç»¼åˆè¿ç”¨ä¸Šé¢æåˆ°çš„å…¨éƒ¨çŸ¥è¯†ï¼Œå¼€å§‹å®ç°æˆ‘ä»¬çš„æ¡†æ¶ã€‚

## å‚è€ƒèµ„æ–™

1. [C++ 11/14/17 æ ‡å‡†åœ¨å„ç¼–è¯‘å™¨ä¸‹æ”¯æŒæƒ…å†µ](http://en.cppreference.com/w/cpp/compiler_support)
2. [C++ IO åº“](http://en.cppreference.com/w/cpp/io)
3. [C++ æ­£åˆ™è¡¨è¾¾å¼åº“](http://en.cppreference.com/w/cpp/regex)
4. [Boost Asio åº“](http://www.boost.org/doc/libs/1_61_0/doc/html/boost_asio.html)